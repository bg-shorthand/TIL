# 비동기 프로그래밍
---
# 동기 처리와 비동기 처리
  - 자바스크립트 엔진은 하나의 콜 스택만 가진다.
  - 즉, 싱글 스레드 방식으로 동작. 한 번에 하나의 태스크만 실행할 수 있기 때문에 처리에 시간이 걸리는 태스크를 실행하는 경우 다음 작업이 블로킹 된다.
  - 이처럼 현재 실행 중인 태스크가 종료할 때까지 다음 태스크가 대기하는 방식을 '동기 처리'라고 한다.
  - 동기 처리 방식은 실행 순서가 보장된다는 장점이 있지만, 앞선 태스크가 종료할 때까지 이후 태스크들이 블로킹되는 단점이 있다.
  - 하지만 setTimeout 함수처럼,
  - 현재 실행 중인 태스크가 종료되지 않은 상태라고 해도, 다음 태스크가 바로 실행되는 방식을 '비동기 처리'라고 한다.
  - 비동기 처리 방식은 블로킹이 발생하지 않는다는 장점이 있지만, 태스크의 실행 순서가 보장되지 않는다는 단점이 있다.
  - 타이머 함수, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작한다.
# 이벤트 루프와 태스크 큐
  - 자바스크립트 엔진은 싱글 스레드로 동작하지만, 브라우저는 멀티 스레드로 동작한다.
  - 자바스크립트 엔진의 환경
    1. 콜 스택
      - 소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조.
    2. 힙
      - 객체가 저장되는 메모리 공간. 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조한다. 객체는 원시값과 달리 크기가 정해져 있지 않으므로, 객체가 저장되는 메모리 공간인 힙은 구조화되어 있지 않다는 특징이 있다.
  - 콜 스택과 힙으로 구성되어 있는 자바스크립트 엔진은, 요청된 작업을 순차적으로만 실행할 수 있다.
  - 즉, 비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저, 또는 Node.js가 담당한다. 이를 위해 브라우저는 태스크 큐와 이벤트 루프를 제공한다.
  - 브라우저의 환경
    1. 태스크 큐
      - setTimeout이나 setInterval과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역,
    2. 이벤트 루프
      - 콜 스택에 현재 실행 중인 실행 컨텍스트가 있는지, 그리고 태스크 큐에 대기 중인 함수(콜백 함수, 이벤트 핸들러 등)가 있는지 반복해서 확인.
      - 콜 스택이 비어 있고, 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프가 '큐' 방식으로 대기 중인 함수를 콜 스택에 이동시킨다. 이 때 이동한 함수는 실행. 즉, 태스크 큐에 일시 보관된 함수들은 비동기 처리 방식으로 동작한다.
  - 비동기 처리 순서(ex. setTimeout 함수)
    1. 전역 코드가 평가되어 전역 실행 컨텍스트가 콜 스택에 푸시.
    2. setTimeout 함수 호출, 함수 실행 컨텍스트가 생성되어 콜 스택에 푸시되어 실행.
    3. setTimeout 함수의 기능에 따라, 콜백 함수를 호출 하고 스케줄링한다. 이후 종료되어 콜 스택에서 팝.
    4. 타이머 설정과 타이머 종료 후 콜백 함수를 태스크 큐에 푸시하는 것은 브라우저의 역할이다.
    5. 브라우저가 수행하는 5.1과 자바스크립트 엔진이 수행하는 5.2는 병행 처리 된다.
      1. 브라우저: 타이머를 설정하고, 타이머의 만료를 기다린다. 타이머가 끝나면 콜백 함수를 태스크 큐에 푸시한다. 태스크 큐에서 대기하는 콜백 함수는 콜 스택이 비어야 호출된다. 따라서 약간의 시간차가 발생할 수 있다.
      2. 이후 처리해야 할 일들을 순차적으로 처리한다.
    6. 전역 코드 실행이 종료되면, 전역 실행 컨텍스트가 콜 스택에서 팝된다.
    7. 이벤트 루프가 콜 스택이 비어 있음을 감지하고, 태스크 큐에서 대기 중인 콜백 함수를 콜 스택에 푸시한다. 즉, 실행.
  - 이처럼 브라우저와 자바스크립트 엔진이 협력하여 비동기 처리를 할 수 있다.
  - 브라우저는 자바스크립트 엔진 외에도 렌더링 엔진과 Web API를 제공한다. Web API는 ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API이며 DOM API와 타이머 함수, HTTP 요청(Ajax)과 같은 비동기 처리를 포함한다.